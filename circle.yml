machine:
  environment:
    GOROOT: ""
    PATH: "/usr/local/go/bin:${HOME}/golang/bin:${PATH}"
    GOPATH: "${HOME}/golang"
    IMPORT_PATH: "github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"

dependencies:
  pre:
    # CircleCI checks out repository to $HOME/goscope.
    # Make sure the code under $GOPATH/src/github.com/zagrodzki/goscope
    # is the exact copy.
    - mkdir -p "$GOPATH/src/$IMPORT_PATH"
    - rsync -aC --delete ./ "$GOPATH/src/$IMPORT_PATH/"
    - go get github.com/golang/lint/golint
    - sudo apt-get update
    - sudo apt-get install libusb-1.0-0-dev

  override:
    - go get -t -d -v "$IMPORT_PATH/..."

test:
  pre:
    - go vet ./...
    - golint ./...
    - |
            FILES="$( find . -name '*.go' -print0 | xargs -0 gofmt -l )"
            [ -n "$FILES" ] && echo -e "go fmt diff in:\n  $FILES" >&2 && exit 1

  override:
    - go build -v "$IMPORT_PATH/..."
    # Test each Go package separately, as go test does not support
    # writing coverage profiles for multiple packages into a single file.
    - |
            echo "" > coverage.txt
            for d in $(go list "$IMPORT_PATH/..." | grep -v vendor); do
              go test -race -coverprofile=profile.out -covermode=atomic $d
              if [ -f profile.out ]; then
                cat profile.out >> coverage.txt
                rm profile.out
              fi
            done

  post:
    # Send coverage reports to codecov.
    - bash <(curl -s https://codecov.io/bash)
