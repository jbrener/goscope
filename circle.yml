machine:
  environment:
    GOROOT: ""
    PATH: "/usr/local/go/bin:${HOME}/golang/bin:${PATH}"
    GOPATH: "${HOME}/golang"
    IMPORT_PATH: "github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"

dependencies:
  pre:
    # CircleCI checks out repository to $HOME/goscope.
    # Make sure the code under $GOPATH/src/github.com/zagrodzki/goscope
    # is the exact copy.
    - sudo rm -rf /usr/local/go
    - curl -s https://storage.googleapis.com/golang/go1.7.1.linux-amd64.tar.gz | sudo tar xzC /usr/local
    - mkdir -p "$GOPATH/src/$IMPORT_PATH"
    - rsync -aC --delete ./ "$GOPATH/src/$IMPORT_PATH/"
    - go get github.com/golang/lint/golint
    - go get github.com/jstemmer/go-junit-report
    - sudo apt-get update
    - sudo apt-get install libusb-1.0-0-dev

  override:
    - go get -t -d -v "$IMPORT_PATH/..."

test:
  pre:
    - go vet ./...
    - golint ./...
    - ./build/gofmt.sh
    - ./build/license.sh

  override:
    - go build -v "$IMPORT_PATH/..."
    - ./build/test-and-coverage.sh

  post:
    # Send coverage reports to codecov.
    - bash <(curl -s https://codecov.io/bash)
